name: Verify Ollama Deployment

on:
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¦ Checkout code
      uses: actions/checkout@v3

    # -----------------------------
    # Docker Build Phase
    # -----------------------------
    - name: ğŸ³ Build Ollama container
      run: docker build -t ollama-gemma -f Dockerfile .

    - name: ğŸ³ Build Metrics Exporter
      run: docker build -t ollama-metrics-exporter -f Dockerfile.exporter .

    # -----------------------------
    # Run Containers
    # -----------------------------
    - name: ğŸš€ Start Ollama container
      run: |
        docker run -d -p 11434:11434 --name ollama ollama-gemma
        echo "â³ Waiting for Ollama to start..."

    - name: ğŸš€ Start Metrics Exporter
      run: |
        docker run -d -p 9101:9101 --name exporter ollama-metrics-exporter

    # -----------------------------
    # Debug + Wait for Ollama
    # -----------------------------
    - name: â±ï¸ Wait for Ollama to be ready
      run: |
        for i in {1..20}; do
          if curl -s http://localhost:11434 > /dev/null; then
            echo "âœ… Ollama is up"
            exit 0
          fi
          echo "â³ Waiting for Ollama... ($i)"
          sleep 3
        done
        echo "âŒ Ollama did not respond in time"
        docker logs ollama
        exit 1

    - name: ğŸ§ª Check Metrics Exporter
      run: |
        for i in {1..10}; do
          if curl -s http://localhost:9101/metrics > /dev/null; then
            echo "âœ… Metrics Exporter is running"
            exit 0
          fi
          echo "â³ Waiting for Metrics Exporter... ($i)"
          sleep 2
        done
        echo "âŒ Metrics Exporter not responding"
        docker logs exporter
        exit 1

    # -----------------------------
    # Load Testing via Locust
    # -----------------------------
    - name: ğŸ§ª Install Locust
      run: pip install locust

    - name: ğŸ§ª Run Locust Test (headless)
      run: |
        locust -f locustfile.py --headless -u 2 -r 1 --run-time 10s --host http://localhost:11434

    # -----------------------------
    # Show container logs if needed
    # -----------------------------
    - name: ğŸ“‹ Show Ollama Logs (for debugging)
      if: failure()
      run: docker logs ollama

    - name: ğŸ“‹ Show Exporter Logs (for debugging)
      if: failure()
      run: docker logs exporter

    - name: ğŸ§ª Run Locust Test (headless)
      run: |
         pip install locust
         locust -f locustfile.py --headless -u 2 -r 1 --run-time 10s --host http://localhost:11434
